<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XSS Demo Chat</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <h1>ðŸ”¥ Global Chat</h1>
        <div class="user-info">
          <span class="username" id="currentUsername"></span>
          <button class="logout-btn" onclick="showProfilePictureModal()">
            Set Picture
          </button>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="error-banner" id="errorBanner"></div>

      <!-- Profile Picture Modal -->
      <div
        id="profilePictureModal"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          align-items: center;
          justify-content: center;
        "
      >
        <div
          style="
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
          "
        >
          <h2 style="margin-bottom: 20px">Set Profile Picture</h2>
          <input
            type="text"
            id="profilePictureInput"
            placeholder="Enter image URL..."
            style="
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 6px;
              margin-bottom: 20px;
            "
          />
          <div style="display: flex; gap: 12px">
            <button
              onclick="saveProfilePicture()"
              style="
                flex: 1;
                padding: 12px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
              "
            >
              Save
            </button>
            <button
              onclick="closeProfilePictureModal()"
              style="
                flex: 1;
                padding: 12px;
                background: #ccc;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
              "
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <div class="messages-container" id="messagesContainer">
        <div class="loading-indicator">Loading messages...</div>
      </div>

      <div class="input-container">
        <form class="input-form" id="messageForm">
          <input
            type="text"
            class="message-input"
            id="messageInput"
            placeholder="Type your message..."
            autocomplete="off"
            required
          />
          <button type="submit" class="send-btn">Send</button>
        </form>
      </div>
    </div>

    <script>
      let currentUser = null;
      let pollingInterval = null;
      let previousMessageCount = 0;

      // Check authentication and get current user
      async function checkAuth() {
        try {
          const response = await fetch('/api/user');
          if (!response.ok) {
            // Not authenticated, redirect to login
            const currentPath = window.location.pathname;
            window.location.href = `/login.html?redirect=${encodeURIComponent(currentPath)}`;
            return false;
          }

          const data = await response.json();
          currentUser = data.username;
          document.getElementById('currentUsername').textContent = currentUser;
          return true;
        } catch (error) {
          showError('Failed to authenticate');
          return false;
        }
      }

      // Fetch and display messages
      async function loadMessages() {
        try {
          const response = await fetch('/api/messages');
          if (!response.ok) {
            if (response.status === 401) {
              // Session expired
              window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.pathname)}`;
              return;
            }
            throw new Error('Failed to load messages');
          }

          const data = await response.json();
          displayMessages(data.messages);
        } catch (error) {
          showError('Failed to load messages');
        }
      }

      // Display messages (with XSS vulnerability for demo purposes)
      function displayMessages(messages) {
        const container = document.getElementById('messagesContainer');

        if (messages.length === 0) {
          container.innerHTML =
            '<div class="loading-indicator">No messages yet. Be the first to say hello!</div>';
          previousMessageCount = 0;
          return;
        }

        // Determine how many new messages there are
        const newMessageCount = messages.length - previousMessageCount;

        container.innerHTML = messages
          .map((msg, index) => {
            const time = new Date(msg.timestamp).toLocaleTimeString();
            const isOwn = msg.username === currentUser;
            // Only add animation class to new messages
            const isNew = index >= previousMessageCount;
            const animationClass = isNew ? 'new' : '';

            // Profile picture with fallback
            // XSS vulnerability: profilePicture URL is not sanitized
            const avatarHtml = msg.profilePicture
              ? `<img src="${msg.profilePicture}" class="message-avatar" onerror="this.style.display='none'">`
              : '';

            // XSS vulnerability: messages are rendered as HTML!
            return `
                    <div class="message ${isOwn ? 'own' : ''} ${animationClass}">
                        <div class="message-header">
                            ${avatarHtml}
                            <span class="message-username">${msg.username}</span>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-content">${msg.message}</div>
                    </div>
                `;
          })
          .join('');

        // Update previous message count
        previousMessageCount = messages.length;

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
      }

      // Helper function to escape HTML
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // Send a message
      async function sendMessage(message) {
        try {
          // Escape HTML in the message before sending to backend
          const escapedMessage = escapeHtml(message);

          const response = await fetch(
            `/api/messages/send?message=${encodeURIComponent(escapedMessage)}`
          );

          if (!response.ok) {
            if (response.status === 401) {
              window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.pathname)}`;
              return;
            }
            throw new Error('Failed to send message');
          }

          // Reload messages immediately after sending
          await loadMessages();
        } catch (error) {
          showError('Failed to send message');
        }
      }

      // Show error banner
      function showError(message) {
        const banner = document.getElementById('errorBanner');
        banner.textContent = message;
        banner.classList.add('show');
        setTimeout(() => {
          banner.classList.remove('show');
        }, 5000);
      }

      // Profile picture modal functions
      function showProfilePictureModal() {
        const modal = document.getElementById('profilePictureModal');
        modal.style.display = 'flex';
      }

      function closeProfilePictureModal() {
        const modal = document.getElementById('profilePictureModal');
        modal.style.display = 'none';
        document.getElementById('profilePictureInput').value = '';
      }

      async function saveProfilePicture() {
        const url = document.getElementById('profilePictureInput').value.trim();
        if (!url) {
          showError('Please enter a valid URL');
          return;
        }

        try {
          const response = await fetch(
            `/api/user/profile-picture?url=${encodeURIComponent(url)}`
          );
          if (!response.ok) {
            throw new Error('Failed to update profile picture');
          }

          closeProfilePictureModal();
          showError('Profile picture updated!');
          setTimeout(() => {
            document.getElementById('errorBanner').classList.remove('show');
          }, 2000);
        } catch (error) {
          showError('Failed to update profile picture');
        }
      }

      // Logout
      function logout() {
        // Clear the session cookie by setting it to expire
        document.cookie =
          'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        window.location.href = '/login.html';
      }

      // Form submission
      document
        .getElementById('messageForm')
        .addEventListener('submit', async (e) => {
          e.preventDefault();
          const input = document.getElementById('messageInput');
          const message = input.value.trim();

          if (message) {
            await sendMessage(message);
            input.value = '';
          }
        });

      // Initialize
      (async () => {
        const authenticated = await checkAuth();
        if (authenticated) {
          await loadMessages();

          // Poll for new messages every 2 seconds
          pollingInterval = setInterval(loadMessages, 2000);
        }
      })();

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (pollingInterval) {
          clearInterval(pollingInterval);
        }
      });
    </script>
  </body>
</html>
